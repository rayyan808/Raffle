<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALICE Raffle</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --color-bg-primary: #0a0a0f;
      --color-bg-secondary: #12121a;
      --color-bg-card: rgba(18, 18, 26, 0.8);
      --color-accent-primary: #00f0ff;
      --color-accent-secondary: #ff00aa;
      --color-accent-gold: #ffd700;
      --color-text-primary: #ffffff;
      --color-text-secondary: #8a8a9a;
      --color-border: rgba(0, 240, 255, 0.2);
      --color-success: #00ff88;
      --color-warning: #ffaa00;
      --font-display: 'Orbitron', sans-serif;
      --font-body: 'Rajdhani', sans-serif;
      --glow-cyan: 0 0 20px rgba(0, 240, 255, 0.5), 0 0 40px rgba(0, 240, 255, 0.2);
      --glow-pink: 0 0 20px rgba(255, 0, 170, 0.5), 0 0 40px rgba(255, 0, 170, 0.2);
      --glow-gold: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.2);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bg-grid {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: 
        linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    .bg-gradient {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(0, 240, 255, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(255, 0, 170, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    #root {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--color-border);
      backdrop-filter: blur(10px);
      background: rgba(10, 10, 15, 0.8);
    }

    .logo {
      font-family: var(--font-display);
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 0.1em;
      background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .connect-btn {
      font-family: var(--font-display);
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      padding: 0.8rem 1.5rem;
      background: transparent;
      border: 2px solid var(--color-accent-primary);
      color: var(--color-accent-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .connect-btn:hover {
      background: rgba(0, 240, 255, 0.1);
      box-shadow: var(--glow-cyan);
    }

    .connect-btn.connected {
      border-color: var(--color-success);
      color: var(--color-success);
    }

    .wallet-address {
      font-family: var(--font-body);
      font-size: 0.8rem;
      color: var(--color-text-secondary);
      margin-top: 0.3rem;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 3rem 2rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.2rem;
      border-radius: 50px;
      font-family: var(--font-display);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 2rem;
    }

    .status-badge.active {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--color-success);
      color: var(--color-success);
    }

    .status-badge.inactive {
      background: rgba(255, 170, 0, 0.1);
      border: 1px solid var(--color-warning);
      color: var(--color-warning);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-badge.active .status-dot {
      background: var(--color-success);
      box-shadow: 0 0 10px var(--color-success);
    }

    .status-badge.inactive .status-dot {
      background: var(--color-warning);
      box-shadow: 0 0 10px var(--color-warning);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      backdrop-filter: blur(20px);
      padding: 2rem;
      width: 100%;
      max-width: 500px;
      position: relative;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
    }

    .card-title {
      font-family: var(--font-display);
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-label {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-family: var(--font-display);
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--color-accent-primary);
      text-shadow: var(--glow-cyan);
    }

    .stat-value.gold {
      color: var(--color-accent-gold);
      text-shadow: var(--glow-gold);
    }

    .stat-unit {
      font-size: 0.8rem;
      color: var(--color-text-secondary);
      margin-left: 0.3rem;
    }

    .rewards-section {
      border-top: 1px solid var(--color-border);
      padding-top: 1.5rem;
      margin-top: 1rem;
    }

    .reward-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: rgba(255, 215, 0, 0.05);
      border: 1px solid rgba(255, 215, 0, 0.2);
      margin-bottom: 1rem;
    }

    .reward-icon { font-size: 1.5rem; margin-right: 1rem; }
    .reward-info { flex: 1; }

    .reward-name {
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--color-accent-gold);
    }

    .reward-type {
      font-size: 0.7rem;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .reward-amount {
      font-family: var(--font-display);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--color-accent-gold);
    }

    .winner-section {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 0, 170, 0.1));
      border: 1px solid rgba(255, 215, 0, 0.3);
      margin-bottom: 1.5rem;
    }

    .winner-label {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--color-accent-gold);
      margin-bottom: 0.5rem;
    }

    .winner-address {
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 500;
      word-break: break-all;
      margin-bottom: 1rem;
    }

    .winner-prize {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 800;
      color: var(--color-accent-gold);
      text-shadow: var(--glow-gold);
    }

    .claim-btn {
      width: 100%;
      padding: 1.2rem 2rem;
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--color-accent-gold), #ff8c00);
      border: none;
      color: #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .claim-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--glow-gold);
    }

    .claim-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-family: var(--font-display);
      font-size: 0.85rem;
      letter-spacing: 0.2em;
      color: var(--color-text-secondary);
      text-transform: uppercase;
    }

    .error-message {
      text-align: center;
      padding: 2rem;
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      color: #ff6b6b;
    }

    .no-winner {
      text-align: center;
      padding: 2rem;
      color: var(--color-text-secondary);
    }

    .no-winner-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      backdrop-filter: blur(10px);
      font-family: var(--font-body);
      font-size: 0.9rem;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success { border-color: var(--color-success); color: var(--color-success); }
    .toast.error { border-color: #ff6b6b; color: #ff6b6b; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .raffle-id {
      font-family: var(--font-display);
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      color: var(--color-text-secondary);
      text-align: center;
      margin-bottom: 1rem;
    }

    .footer {
      text-align: center;
      padding: 1.5rem;
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      border-top: 1px solid var(--color-border);
    }

    @media (max-width: 600px) {
      .header { flex-direction: column; gap: 1rem; text-align: center; }
      .stats-grid { grid-template-columns: 1fr; }
      .card { padding: 1.5rem; }
      .stat-value { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="bg-gradient"></div>
  <div id="root">
    <div class="main">
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ============ CONFIGURATION - EDIT THESE VALUES ============
    
    // Your deployed Raffle contract address
    const RAFFLE_CONTRACT_ADDRESS = '0x2688184E2bBde09b7D22f0691f0D4ebbD3b39b1C';
    
    // Network RPC URL (Sepolia example)
    const RPC_URL = 'https://gateway.tenderly.co/public/sepolia';
    const CHAIN_ID = 11155111;
    const CHAIN_NAME = 'Sepolia Testnet';
    
    // ALICE Token decimals
    const ALICE_DECIMALS = 6;
    
    // ============ END CONFIGURATION ============

    // Contract ABI (minimal)
    const RAFFLE_ABI = [
      "function paused() view returns (bool)",
      "function currentRaffleId() view returns (uint256)",
      "function getRaffleConfig(uint256 raffleId) view returns (tuple(uint256 ticketPrice, string genericReward, uint8 genericRewardAmount, string winnerReward, uint8 winnerRewardAmount, uint256 prizePool, address winner, bool winnerClaimed, bool isActive))",
      "function getTicketCount(uint256 raffleId) view returns (uint256)",
      "function calculateWinnerPrize(uint256 raffleId) view returns (uint256)",
      "function claimWinnerReward(uint256 raffleId)",
    ];

    // Helpers
    const formatAlice = (amount) => {
      if (!amount) return '0';
      return ethers.utils.formatUnits(amount, ALICE_DECIMALS);
    };

    const shortenAddress = (address) => {
      if (!address) return '';
      return `${address.slice(0, 6)}...${address.slice(-4)}`;
    };

    // Main App
    function App() {
      const [provider, setProvider] = useState(null);
      const [signer, setSigner] = useState(null);
      const [userAddress, setUserAddress] = useState(null);
      const [contract, setContract] = useState(null);
      
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [toast, setToast] = useState(null);
      
      const [raffleData, setRaffleData] = useState(null);
      const [isActive, setIsActive] = useState(false);
      const [claiming, setClaiming] = useState(false);

      // Initialize read-only provider
      useEffect(() => {
        const init = async () => {
          try {
            const readProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
            setProvider(readProvider);
            
            const raffleContract = new ethers.Contract(
              RAFFLE_CONTRACT_ADDRESS,
              RAFFLE_ABI,
              readProvider
            );
            setContract(raffleContract);
          } catch (err) {
            console.error('Init error:', err);
            setError('Failed to connect to network');
          }
          setLoading(false);
        };
        init();
      }, []);

      // Connect wallet (MetaMask or other injected provider)
      const connectWallet = async () => {
        if (!window.ethereum) {
          showToast('Please install MetaMask or another Web3 wallet', 'error');
          return;
        }

        try {
          const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
          });
          
          // Check network
          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (parseInt(chainId, 16) !== CHAIN_ID) {
            showToast(`Please switch to ${CHAIN_NAME}`, 'error');
            return;
          }

          const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
          const web3Signer = web3Provider.getSigner();
          
          setSigner(web3Signer);
          setUserAddress(accounts[0]);
          
          // Update contract with signer
          const signedContract = new ethers.Contract(
            RAFFLE_CONTRACT_ADDRESS,
            RAFFLE_ABI,
            web3Signer
          );
          setContract(signedContract);
          
          showToast('Wallet connected!', 'success');
        } catch (err) {
          console.error('Connect error:', err);
          showToast('Failed to connect wallet', 'error');
        }
      };

      // Disconnect
      const disconnectWallet = () => {
        setSigner(null);
        setUserAddress(null);
        // Reset to read-only contract
        if (provider) {
          const readContract = new ethers.Contract(
            RAFFLE_CONTRACT_ADDRESS,
            RAFFLE_ABI,
            provider
          );
          setContract(readContract);
        }
        showToast('Wallet disconnected', 'success');
      };

      // Fetch raffle data
      const fetchRaffleData = useCallback(async () => {
        if (!contract) return;

        try {
          const [paused, currentRaffleId] = await Promise.all([
            contract.paused(),
            contract.currentRaffleId(),
          ]);

          const raffleId = currentRaffleId.toNumber();
          
          if (raffleId === 0) {
            setRaffleData({ raffleId: 0, noRaffle: true });
            setIsActive(false);
            return;
          }

          const [config, ticketCount] = await Promise.all([
            contract.getRaffleConfig(raffleId),
            contract.getTicketCount(raffleId),
          ]);

          let winnerPrize = ethers.BigNumber.from(0);
          if (config.winner !== ethers.constants.AddressZero && !config.winnerClaimed) {
            try {
              winnerPrize = await contract.calculateWinnerPrize(raffleId);
            } catch (e) {}
          }

          setRaffleData({
            raffleId,
            ticketPrice: config.ticketPrice,
            genericReward: config.genericReward,
            genericRewardAmount: config.genericRewardAmount,
            winnerReward: config.winnerReward,
            winnerRewardAmount: config.winnerRewardAmount,
            prizePool: config.prizePool,
            winner: config.winner,
            winnerClaimed: config.winnerClaimed,
            isActive: config.isActive,
            ticketCount: ticketCount.toNumber(),
            winnerPrize,
          });

          setIsActive(!paused && config.isActive);
          setError(null);
        } catch (err) {
          console.error('Fetch error:', err);
          setError('Failed to load raffle data. Check contract address and network.');
        }
      }, [contract]);

      // Poll for data
      useEffect(() => {
        if (!contract) return;
        fetchRaffleData();
        const interval = setInterval(fetchRaffleData, 15000);
        return () => clearInterval(interval);
      }, [contract, fetchRaffleData]);

      // Claim reward
      const claimReward = async () => {
        if (!contract || !signer || !raffleData) return;

        setClaiming(true);
        try {
          const tx = await contract.claimWinnerReward(raffleData.raffleId);
          showToast('Transaction submitted...', 'success');
          await tx.wait();
          showToast('Reward claimed successfully!', 'success');
          fetchRaffleData();
        } catch (err) {
          console.error('Claim error:', err);
          showToast(err.reason || 'Failed to claim reward', 'error');
        }
        setClaiming(false);
      };

      // Toast
      const showToast = (message, type) => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 4000);
      };

      // Check if user is winner
      const isUserWinner = userAddress && raffleData?.winner && 
        userAddress.toLowerCase() === raffleData.winner.toLowerCase();

      const ZERO_ADDRESS = '0x0000000000000000000000000000000000000000';

      return (
        <>
          <header className="header">
            <div className="logo">ALICE RAFFLE</div>
            <div>
              {userAddress ? (
                <div style={{ textAlign: 'right' }}>
                  <button className="connect-btn connected" onClick={disconnectWallet}>
                    Connected
                  </button>
                  <div className="wallet-address">{shortenAddress(userAddress)}</div>
                </div>
              ) : (
                <button className="connect-btn" onClick={connectWallet}>
                  Connect Wallet
                </button>
              )}
            </div>
          </header>

          <main className="main">
            {loading ? (
              <div className="loading-container">
                <div className="loading-spinner"></div>
                <div className="loading-text">Initializing</div>
              </div>
            ) : error ? (
              <div className="card">
                <div className="error-message">{error}</div>
              </div>
            ) : raffleData?.noRaffle ? (
              <div className="card">
                <div className="no-winner">
                  <div className="no-winner-icon">üé∞</div>
                  <p>No raffle has been started yet.</p>
                </div>
              </div>
            ) : isActive ? (
              /* STATE B: Raffle Active */
              <>
                <div className="status-badge active">
                  <span className="status-dot"></span>
                  Raffle Active
                </div>

                <div className="card">
                  <div className="raffle-id">Raffle #{raffleData?.raffleId}</div>
                  <h2 className="card-title">Current Raffle</h2>

                  <div className="stats-grid">
                    <div className="stat-item">
                      <div className="stat-label">Prize Pool</div>
                      <div className="stat-value gold">
                        {formatAlice(raffleData?.prizePool)}
                        <span className="stat-unit">ALICE</span>
                      </div>
                    </div>
                    <div className="stat-item">
                      <div className="stat-label">Tickets Sold</div>
                      <div className="stat-value">
                        {raffleData?.ticketCount || 0}
                      </div>
                    </div>
                  </div>

                  <div className="rewards-section">
                    <div className="reward-item">
                      <span className="reward-icon">üéÅ</span>
                      <div className="reward-info">
                        <div className="reward-name">{raffleData?.genericReward || 'N/A'}</div>
                        <div className="reward-type">Participation Reward</div>
                      </div>
                      <div className="reward-amount">x{raffleData?.genericRewardAmount || 0}</div>
                    </div>

                    <div className="reward-item">
                      <span className="reward-icon">üèÜ</span>
                      <div className="reward-info">
                        <div className="reward-name">{raffleData?.winnerReward || 'N/A'}</div>
                        <div className="reward-type">Winner Reward</div>
                      </div>
                      <div className="reward-amount">x{raffleData?.winnerRewardAmount || 0}</div>
                    </div>
                  </div>
                </div>
              </>
            ) : (
              /* STATE A: Raffle Inactive */
              <>
                <div className="status-badge inactive">
                  <span className="status-dot"></span>
                  Raffle Ended
                </div>

                <div className="card">
                  <div className="raffle-id">Raffle #{raffleData?.raffleId}</div>
                  <h2 className="card-title">Previous Raffle</h2>

                  {raffleData?.winner && raffleData.winner !== ZERO_ADDRESS ? (
                    <>
                      <div className="winner-section">
                        <div className="winner-label">üèÜ Winner</div>
                        <div className="winner-address">
                          {isUserWinner ? 'üéâ YOU!' : shortenAddress(raffleData.winner)}
                        </div>
                        {!raffleData.winnerClaimed && (
                          <div className="winner-prize">
                            {formatAlice(raffleData.winnerPrize)} ALICE
                          </div>
                        )}
                        {raffleData.winnerClaimed && (
                          <div style={{ color: 'var(--color-success)', fontSize: '0.85rem' }}>
                            ‚úì Prize Claimed
                          </div>
                        )}
                      </div>

                      <div className="rewards-section">
                        <div className="reward-item">
                          <span className="reward-icon">üèÜ</span>
                          <div className="reward-info">
                            <div className="reward-name">{raffleData?.winnerReward || 'N/A'}</div>
                            <div className="reward-type">Winner Reward</div>
                          </div>
                          <div className="reward-amount">x{raffleData?.winnerRewardAmount || 0}</div>
                        </div>
                      </div>

                      {isUserWinner && !raffleData.winnerClaimed && (
                        <button 
                          className={`claim-btn ${claiming ? 'loading' : ''}`}
                          onClick={claimReward}
                          disabled={claiming || !signer}
                        >
                          {claiming ? 'Claiming...' : 'Claim Your Reward'}
                        </button>
                      )}

                      {!userAddress && !raffleData.winnerClaimed && (
                        <p style={{ textAlign: 'center', color: 'var(--color-text-secondary)', marginTop: '1rem', fontSize: '0.85rem' }}>
                          Connect your wallet to check if you're the winner
                        </p>
                      )}
                    </>
                  ) : (
                    <div className="no-winner">
                      <div className="no-winner-icon">‚è≥</div>
                      <p>Awaiting winner selection...</p>
                      <p style={{ fontSize: '0.8rem', marginTop: '0.5rem' }}>
                        The VRF callback will determine the winner shortly.
                      </p>
                    </div>
                  )}
                </div>
              </>
            )}
          </main>

          <footer className="footer">
            <p>Powered by Chainlink VRF ‚Ä¢ {CHAIN_NAME}</p>
          </footer>

          {toast && (
            <div className={`toast ${toast.type}`}>
              {toast.message}
            </div>
          )}
        </>
      );
    }

    // Mount
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
